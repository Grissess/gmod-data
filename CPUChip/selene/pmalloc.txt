#ifndef SELENE_PMALLOC
#define SELENE_PMALLOC

#include <selene/std.txt>
#include <selene/cpu.txt>

char *pg_round(char *addr) {
    return PAGESIZE * to_int(addr >> PAGEBITS);
}

char *pg_roundup(char *addr) {
    return PAGESIZE * to_int((addr + PAGESIZE - 1) >> PAGEBITS);
}

char *pmalloc_top = NULL;

void pfree(char *addr) {
    char *pg = pg_round(addr);
    *pg = pmalloc_top;
    pmalloc_top = pg;
}

void pfreerange(char *start, char *end) {
    char *cur = pg_round(start);
    char *stop = pg_round(end);
    if(cur != start) cur += PAGESIZE;
    while(cur < stop) {
        pfree(cur);
        cur += PAGESIZE;
    }
}

char *pmalloc() {
    if(!pmalloc_top) return 0;
    char *pg = pmalloc_top;
    pmalloc_top = *pmalloc_top;
    return pg;
}

#endif
